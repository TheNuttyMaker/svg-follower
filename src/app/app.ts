import '../styles.scss';
import './app.scss';
import { Follower } from './follower/follower';
import { Input } from './input';
import { Position } from './Position';
import { Observable, Subscription } from '../../node_modules/rxjs';

const html = require('./app.html');

export class App
{
	private container:HTMLElement;
	private svg:HTMLElement;

	private width: number = 600;
	private height: number = 600;
	private autoMouse:Subscription;

	private followers:Follower[] = [];
	private colors = ['red', 'blue', 'green', 'yellow'];//, 'white'];

	private previewMode:boolean = false;
	private record:boolean = false;
	private recording:Position[] = [];

	constructor(container:HTMLElement)
	{
		console.log('APP STARTED')

		this.container = container;
		this.container.innerHTML = html;

		this.svg = document.getElementById('stage');
		window.addEventListener('resize', () => this.onResize())
		this.onResize();

		this.colors.map(color => this.followers.push(new Follower(this.svg, color)));
		
		let input = new Input(this.container);

		input.starts.subscribe(() => 
		{
			this.recording = [];
			this.record = true;
		})
		input.ends.subscribe(() => {
			this.record = false;
			console.clear(); 
			console.log(JSON.stringify(this.recording));
		});

		input.moves
			.distinctUntilChanged((a:Position, b:Position) => a.x == b.x && a.y == b.y)
			.subscribe((position:Position) => {
				if(this.autoMouse) this.autoMouse.unsubscribe();
				this.followers.map(follower => follower.add(position));
				if(this.record)
				{
					this.recording.push({
						x: (position.x / this.width) * 100,
						y: (position.y / this.height) * 100
					})
				}
			})

		let path = [{"x":49.72222222222222,"y":53.669724770642205},{"x":49.30555555555556,"y":53.669724770642205},{"x":48.40277777777778,"y":53.669724770642205},{"x":47.77777777777778,"y":53.36391437308868},{"x":47.291666666666664,"y":52.44648318042814},{"x":46.94444444444444,"y":50.917431192660544},{"x":46.80555555555556,"y":49.08256880733945},{"x":46.80555555555556,"y":46.48318042813456},{"x":46.80555555555556,"y":44.03669724770643},{"x":47.638888888888886,"y":41.59021406727829},{"x":49.236111111111114,"y":39.296636085626915},{"x":51.59722222222223,"y":37.920489296636084},{"x":54.30555555555555,"y":37.920489296636084},{"x":57.36111111111111,"y":37.920489296636084},{"x":59.72222222222222,"y":39.44954128440367},{"x":61.59722222222223,"y":42.354740061162076},{"x":62.708333333333336,"y":45.10703363914373},{"x":63.125,"y":47.40061162079511},{"x":63.19444444444444,"y":50.45871559633027},{"x":62.916666666666664,"y":54.43425076452599},{"x":61.458333333333336,"y":58.86850152905198},{"x":58.88888888888889,"y":64.22018348623854},{"x":55.76388888888889,"y":68.65443425076452},{"x":53.541666666666664,"y":70.64220183486239},{"x":50.625,"y":72.17125382262996},{"x":46.31944444444444,"y":72.47706422018348},{"x":42.84722222222222,"y":71.55963302752293},{"x":40.625,"y":69.1131498470948},{"x":37.84722222222222,"y":65.13761467889908},{"x":35.833333333333336,"y":61.16207951070336},{"x":34.375,"y":56.727828746177366},{"x":33.19444444444444,"y":46.17737003058104},{"x":33.19444444444444,"y":37.76758409785933},{"x":33.81944444444444,"y":30.122324159021407},{"x":35.90277777777778,"y":20.795107033639145},{"x":38.263888888888886,"y":14.067278287461773},{"x":42.01388888888889,"y":7.79816513761468},{"x":45.55555555555556,"y":5.81039755351682},{"x":50.27777777777778,"y":5.351681957186544},{"x":56.25,"y":6.574923547400611},{"x":62.43055555555556,"y":13.149847094801222},{"x":68.26388888888889,"y":21.865443425076453},{"x":71.59722222222223,"y":28.287461773700308},{"x":74.86111111111111,"y":37.15596330275229},{"x":77.70833333333333,"y":50.917431192660544},{"x":77.77777777777779,"y":60.39755351681957},{"x":77.08333333333334,"y":67.12538226299695},{"x":74.23611111111111,"y":75.53516819571865},{"x":70.41666666666667,"y":83.33333333333334},{"x":66.04166666666667,"y":89.14373088685015},{"x":60.83333333333333,"y":93.11926605504587},{"x":55.55555555555556,"y":95.565749235474},{"x":48.95833333333333,"y":96.17737003058105},{"x":42.083333333333336,"y":96.63608562691131},{"x":35.41666666666667,"y":96.63608562691131},{"x":31.59722222222222,"y":95.41284403669725},{"x":27.083333333333332,"y":92.66055045871559},{"x":24.02777777777778,"y":89.29663608562691},{"x":20.833333333333336,"y":83.63914373088684},{"x":19.166666666666668,"y":78.2874617737003},{"x":17.569444444444443,"y":67.73700305810397},{"x":17.569444444444443,"y":56.42201834862385},{"x":18.47222222222222,"y":46.94189602446483},{"x":20.90277777777778,"y":37.76758409785933},{"x":23.88888888888889,"y":30.275229357798167},{"x":27.84722222222222,"y":23.547400611620795},{"x":32.013888888888886,"y":18.960244648318042},{"x":36.80555555555556,"y":16.36085626911315},{"x":41.80555555555556,"y":15.443425076452598},{"x":44.93055555555556,"y":15.443425076452598},{"x":50.55555555555556,"y":18.807339449541285},{"x":53.19444444444444,"y":21.712538226299692},{"x":56.25,"y":26.146788990825687},{"x":58.333333333333336,"y":29.81651376146789},{"x":59.09722222222222,"y":32.26299694189603},{"x":60.34722222222222,"y":36.391437308868504},{"x":60.763888888888886,"y":39.44954128440367},{"x":60.90277777777777,"y":42.6605504587156},{"x":60.90277777777777,"y":45.56574923547401},{"x":60.90277777777777,"y":48.1651376146789},{"x":60.55555555555555,"y":50.917431192660544},{"x":59.86111111111111,"y":53.36391437308868},{"x":59.02777777777778,"y":55.81039755351682},{"x":58.05555555555556,"y":57.3394495412844},{"x":57.49999999999999,"y":57.95107033639144},{"x":56.666666666666664,"y":58.56269113149847},{"x":55.41666666666667,"y":58.86850152905198},{"x":54.79166666666667,"y":58.86850152905198},{"x":53.61111111111111,"y":58.86850152905198},{"x":53.263888888888886,"y":58.86850152905198},{"x":52.56944444444444,"y":58.86850152905198},{"x":52.15277777777778,"y":58.86850152905198},{"x":51.87500000000001,"y":58.71559633027523},{"x":51.59722222222223,"y":58.56269113149847},{"x":51.24999999999999,"y":58.256880733944946},{"x":51.041666666666664,"y":57.95107033639144},{"x":50.90277777777777,"y":57.645259938837924},{"x":50.763888888888886,"y":57.18654434250765},{"x":50.625,"y":56.88073394495413},{"x":50.55555555555556,"y":56.42201834862385},{"x":50.416666666666664,"y":56.11620795107034},{"x":50.416666666666664,"y":55.35168195718655},{"x":50.34722222222222,"y":54.43425076452599},{"x":50.34722222222222,"y":53.36391437308868},{"x":50.34722222222222,"y":52.14067278287462},{"x":50.34722222222222,"y":51.52905198776758},{"x":50.34722222222222,"y":51.223241590214066}]
		if(this.previewMode) this.autoMouse = Observable.interval(25).map(i => path[i % path.length])
			.map((p:Position) => {
				return {
					x: (p.x / 100) * this.width, 
					y: (p.y / 100) * this.height 
				}
			})
			.subscribe((position:Position) => this.followers.map(follower => follower.add(position)))
		
	}

	onResize()
	{
		this.width = this.container.offsetWidth;
		this.height = this.container.offsetHeight;

		this.svg.setAttribute('width', String(this.width));
		this.svg.setAttribute('height', String(this.height));
	}
}